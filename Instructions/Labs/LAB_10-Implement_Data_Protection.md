---
lab:
  title: 'ラボ 10: データ保護を実装する'
  module: Administer Data Protection
---

# 課題 10 – データ保護を実装する

## ラボ概要    

このラボでは、Azure 仮想マシンのバックアップと回復について説明します。 Azure 仮想マシン用の Recovery Services コンテナーとバックアップ ポリシーを作成する方法について説明します。 Azure Site Recovery を使用したディザスター リカバリーについて説明します。 

このラボでは Azure サブスクリプションが必要です。 サブスクリプションの種類が、このラボで使用可能な機能に影響を与える可能性があります。 リージョンを変更できますが、その手順は**米国東部**と**米国西部**を使用して記述されています。

## 推定時間:50 分

## ラボのシナリオ

組織は、偶発的または悪意のあるデータ損失から Azure 仮想マシンをバックアップおよび復元する方法を評価しています。 さらに、組織は、Azure Site Recovery のディザスター リカバリー シナリオのための使用を調査したいと考えています。 

## 対話型のラボ シミュレーション

このトピックに役立つ可能性のある対話型ラボ シミュレーションがあります。 このシミュレーションを使用すると、同様のシナリオを自分のペースでクリックしながら進めることができます。 対話型シミュレーションとこのラボには違いがありますが、主要な概念の多くは同じです。 Azure サブスクリプションは必要ありません。

+ **[仮想マシンとオンプレミス ファイルをバックアップします。](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%2016)** Recovery Services コンテナーを作成し、Azure 仮想マシンのバックアップを実装します。 Microsoft Azure Recovery Services エージェントを使用して、オンプレミス ファイルおよびフォルダーのバックアップを実装します。 オンプレミスのバックアップはこのラボの範囲外ですが、その手順を表示すると役立つ場合があります。 

## 職務スキル

+ タスク 1:テンプレートを使用してインフラストラクチャをプロビジョニングします。
+ タスク 2:Recovery Services コンテナーを作成して構成します。
+ タスク 3:Azure 仮想マシン レベルのバックアップを構成します。
+ タスク 4:Azure Backup を監視します。
+ タスク 5:仮想マシンのレプリケーションを有効にします。 

## 推定時間:40 分

## アーキテクチャの図

![アーキテクチャのタスクの図。](../media/az104-lab10-architecture.png)

## タスク 1:テンプレートを使用してインフラストラクチャをプロビジョニングする

このタスクでは、テンプレートを使用して仮想マシンをデプロイします。 これらの仮想マシンは、さまざまなバックアップ シナリオをテストするために使用されます。

1. **\\Allfiles\\Lab10\\** ラボ ファイルをダウンロードします。

1. **Azure portal** - `https://portal.azure.com` にサインインします。

1. `Deploy a custom template` を検索して選択します。

1. [カスタム デプロイ] ページで、**[エディターで独自のテンプレートを作成する]** を選択します。

1. [テンプレートの編集] ページで、**[ファイルの読み込み]** を選択します。

1. **\\Allfiles\\Lab10\\az104-10-vms-edge-template.json** ファイルを見つけて選択し、**[開く]** を選択します。

   >**注:**  少し時間を取ってテンプレートを確認します。 バックアップと回復をデモンストレーションできるように、仮想ネットワークと仮想マシンをデプロイしています。 

1. 変更内容を**保存**します。

1. **[パラメーターの編集]**、**[ファイルの読み込み]** の順に選択します。

1. **\\Allfiles\\Lab10\\az104-10-vms-edge-parameters.json** ファイルを読み込んで選択します。

1. 変更内容を**保存**します。

1. 次の情報を使用してカスタム デプロイ フィールドを完了します。他のすべてのフィールドは既定値のままにします。

    | 設定       | 値         | 
    | ---           | ---           |
    | サブスクリプション  | お使いの Azure サブスクリプション |
    | Resource group| `az104-rg-region1` (必要に応じて、**[新規作成]** を選択します)
    | リージョン        | **米国東部**   |
    | ユーザー名      | **localadmin**   |
    | Password      | 複雑なパスワードを指定します |

1. **[確認および作成]** を選択し、次に **[作成]** を選択します。

    >**注:**  テンプレートがデプロイされるまで待ってから、**[リソースに移動]** を選択します。 1 つの仮想ネットワーク内に 1 つの仮想マシンが必要です。 

## タスク 2:Recovery Services コンテナーを作成して構成する

このタスクでは、Recovery Services コンテナーを作成します。 Recovery Services コンテナーは、仮想マシン データのストレージを提供します。 

1. Azure portal で、`Recovery Services vaults` を検索して選択し、**[Recovery Services コンテナー]** ブレードで **[+ 作成]** をクリックします。

1. **[Recovery Services コンテナーの作成]** ウィンドウで、次の設定を指定します。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | "Azure サブスクリプションの名前" |
    | リソース グループ | `az104-rg-region1`  |
    | コンテナー名 | `az104-rsv-region1` |
    | リージョン | **米国東部** |

    >**注**: 前のタスクで仮想マシンをデプロイしたリージョンを必ず指定してください。

    ![Recovery Services コンテナーのスクリーンショット。](../media/az104-lab10-create-rsv.png)

1. **[確認と作成]** をクリックし、検証が成功したことを確認してから **[作成]** をクリックします。

    >**注**: デプロイが完了するまで待ちます。 デプロイには数分かかります。 

1. デプロイが完了したら、**[リソースに移動]** をクリックします。

1. [Recovery Services コンテナー] ブレードで、**[設定]** セクションの **[プロパティ]** をクリックします。

1. **[バックアップ構成]** ラベルの下の **[更新]** リンクを選択します。

1. [**バックアップ構成**] ブレードで、**ストレージ レプリケーションの種類**の選択肢を確認します。 既定の設定である **[geo 冗長]** のままにして、ウィンドウを閉じます。

    >**注**:この設定は、既存のバックアップ アイテムがない場合にのみ構成できます。
    
    >**ご存知でしたか?** リージョンをまたがる復元オプションを使用すると、データをセカンダリ リージョン ([Azure のペアになっているリージョン](https://learn.microsoft.com/azure/backup/backup-create-recovery-services-vault#set-cross-region-restore)) に復元できます。 

1. [Recovery Services コンテナー] ブレードに戻り、**[セキュリティ設定] > [論理的な削除とセキュリティ設定]** ラベルの下の **[更新]** リンクをクリックします。

1. **[セキュリティ設定]** ブレードで、 **[論理的な削除] (Azure 仮想マシンの場合)** が **[有効]** であることを確認します。 **[論理的な削除の保持期間]** が **14** 日であることに注意してください。 

1. [Recovery Services コンテナー] ブレードに戻り、**[概要]** ブレードを選択します。

>**ご存知でしたか?** Azure には、次の 2 種類のコンテナーがあります。Recovery Services コンテナーと Backup ボールト。 主な違いは、バックアップできるデータソースにあります。 [それらの違い](https://learn.microsoft.com/answers/questions/405915/what-is-difference-between-recovery-services-vault)に関する詳細を確認してください。

## タスク 3:Azure 仮想マシン レベルのバックアップを構成する

このタスクでは、Azure 仮想マシン レベルのバックアップを実装します。 VM のバックアップの一部として、そのバックアップに適用されるバックアップおよび保持ポリシーを定義する必要があります。 VM ごとに異なるバックアップおよび保持ポリシーを割り当てることができます。

   >**注**:このタスクを開始する前に、このラボの最初のタスクで開始したデプロイが正常に完了したことを確認します。

1. [Recovery Services コンテナー] ブレードで、**[概要]**、**[+ バックアップ]** の順にクリックします。

1. **[バックアップの目標]** ウィンドウで、次の設定を指定します。

    | 設定 | 値 |
    | --- | --- |
    | ワークロードはどこで実行されていますか? | **[Azure]** (他のオプションに注意してください) |
    | バックアップの対象。 | **[仮想マシン]** (他のオプションに注意してください) |

1. **[Backup](バックアップ)** を選択します。

1. **ポリシーのサブタイプ**には次の 2 つがあることに注意してください。**[拡張]** と **[標準]**。 選択肢を確認し、**[標準]** を選択します。 

1. **[バックアップ ポリシー]** で、**[新しいポリシーの作成]** を選択します。

1. 次の設定を使用して新しいバックアップ ポリシーを定義します (他の設定は既定値のままにします)。

    | 設定 | 値 |
    | ---- | ---- |
    | ポリシー名 | `az104-backup` |
    | 頻度 | **毎日** |
    | Time | **12:00 AM** |
    | タイム ゾーン | ローカル タイム ゾーンの名前 |
    | のインスタント回復スナップショットを保持 | **2** 日間 |

    ![[バックアップ ポリシー] ページのスクリーンショット。](../media/az104-lab10-backup-policy.png)

1. **[OK]** をクリックしてポリシーを作成し、**[仮想マシン]** セクションで **[追加]** を選択します。

1. **[仮想マシンの選択]** ブレードで、**[az-104-10-vm0]** を選択して **[OK]** をクリックしてから、**[バックアップ]** ブレードに戻り、**[バックアップの有効化]** をクリックします。

    >**注**:バックアップが有効になるまで待ちます。 これには約 2 分かかります。

1. **[保護された項目]** セクションで、**[バックアップ項目]**、**[Azure 仮想マシン]** エントリの順にクリックします。

1. **az104-10-vm0** の **[詳細の表示]** リンクを選択し、**[バックアップの事前チェック]** および **[前回のバックアップの状態]** エントリの値を確認します。

    >**注:**  バックアップが保留中であることに注意してください。
    
1. **[今すぐバックアップ]** を選択し、**[バックアップの保持期限]** ドロップダウン リストで既定値をそのまま使用し、**[OK]** をクリックします。

    >**注**:バックアップが完了するのを待たずに、次のタスクに進みます。

## タスク 4:Azure Backup を監視する

このタスクでは、Azure ストレージ アカウントをデプロイします。 その後、そのストレージ アカウントにログとメトリックを送信するようにコンテナーを構成します。 それにより、このリポジトリを Log Analytics またはその他のサード パーティの監視ソリューションで使用できるようになります。

1. Azure portal から、`Storage accounts` を検索して選択します。

1. [ストレージ アカウント] ページで、**[作成]** を選択します。

1. 次の情報を使用してストレージ アカウントを定義してから、**[確認]** を選択します。

    | 設定 | 値 |
    | --- | --- | 
    | サブスクリプション          | *該当するサブスクリプション*    |
    | リソース グループ        | **az104-rg-region1**        |
    | ストレージ アカウント名  | グローバルに一意の名前を指定します   |
    | リージョン                | **米国東部**   |

1. [確認] タブで、**[作成]** を選択します。

    >**注**: デプロイが完了するまで待ちます。 これには約 1 分かかります。

1. Recovery Services コンテナーを検索して選択します。

1. **[診断設定]**、**[診断設定の追加]** の順に選択します。

1. 設定に `Logs and Metrics to storage` という名前を付けます。

1. 次のログおよびメトリック カテゴリの横にチェックマークを付けます。

    - **Azure Backup レポート データ**
    - **アドオン Azure Backup ジョブ データ**
    - **アドオン Azure Backup アラート データ**
    - **Azure Site Recovery ジョブ**
    - **Azure Site Recovery イベント**
    - **正常性**

1. [宛先の詳細] で、**[ストレージ アカウントへのアーカイブ]** の横にチェックマークを付けます。

1. [ストレージ アカウント] ドロップダウン フィールドで、このタスクで前にデプロイしたストレージ アカウントを選択します。

1. **[保存]** を選択します。

1. Recovery Services コンテナーに戻り、**[監視]** ブレードで **[バックアップ ジョブ]** を選択します。

1. **az104-10-vm0** 仮想マシンのバックアップ操作を見つけます。 

1. バックアップ ジョブの詳細を確認します。

## タスク 5:仮想マシンのレプリケーションを有効にする

1. Azure portal で、`Recovery Services vaults` を検索して選択し、**[Recovery Services コンテナー]** ブレードで **[+ 作成]** をクリックします。

1. **[Recovery Services コンテナーの作成]** ウィンドウで、次の設定を指定します。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | "Azure サブスクリプションの名前" |
    | リソース グループ | `az104-rg-region2` (必要に応じて、**[新規作成]** を選択します) |
    | コンテナー名 | `az104-rsv-region2` |
    | リージョン | **米国西部** |

    >**注**:必ず、仮想マシンとは**異なる**リージョンを指定してください。

1. **[確認と作成]** をクリックし、検証が成功したことを確認してから **[作成]** をクリックします。

    >**注**: デプロイが完了するまで待ちます。 デプロイには数分かかります。 

1. `az104-10-vm0` 仮想マシンを検索して選択します。

1. **[バックアップとディザスター リカバリー]** ブレードで、**[ディザスター リカバリー]** を選択します。 

1. **[レプリケーションを有効にする]** を選択します。

1. **[基本]** タブで、**[ターゲット リージョン]** に注意してください。

1. **[詳細設定]** タブに移動します。リソースの選択が自動的に行われました。 それらを確認することが重要です。 

1. サブスクリプション、VM リソース グループ、仮想ネットワーク、可用性 (既定値を選択します) の各設定を確認します。

1. **[ストレージの設定]** で、**[詳細の表示]** を選択します。

    | 設定 | Value |
    | ---- | ---- |
    | VM のチャーン | **通常のチャーン**  |
    | キャッシュ ストレージ アカウント | **(新規) xxx**  |

   >**注:**  これらの両方の設定に値が入力されていることが重要です。そうでないと、検証が失敗します。 値が存在しない場合は、ページを更新してみてください。 それが機能しない場合は、空のストレージ アカウントを作成してから、このページに戻ります。

1. **[レプリケーションの設定]** で、**[詳細の表示]** を選択します。 リージョン 2 内の回復リソース コンテナーが自動的に選択されたことに注意してください。

1. **[レプリケーションの確認と開始]**、**[レプリケーションを有効にする]** の順に選択します。

    >**注**:レプリケーションの有効化には 10 分から 15 分かかります。 ポータルの右上にある通知メッセージを監視します。 待っている間に、このページの最後にある自習トレーニングのリンクを確認することを検討してください。
    
1. レプリケーションが完了したら、Recovery Services コンテナー **az104-rsv-region2** を検索して見つけます。 ページを**更新**する必要がある場合があります。 

1. **[保護された項目]** セクションで、**[レプリケートされた項目]** を選択します。

1. 仮想マシンがレプリケーションの正常性に関して正常として示されていることを確認します。 状態には同期の状態 (0% から開始) が表示され、最終的に初期同期が完了すると **[保護]** が表示されることに注意してください。

   ![[レプリケートされた項目] ページのスクリーンショット。](../media/az104-lab10-replicated-items.png)

1. 仮想マシンを選択して詳細情報を表示します。
   
>**ご存知でしたか?** [保護された VM のフェールオーバーをテストする](https://learn.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure#run-a-test-failover-for-a-single-vm)ことをお勧めします。

## リソースのクリーンアップ

**自分のサブスクリプション**で作業している場合は、お手数ですが、ラボ リソースを削除してください。 これにより、リソースが確実に解放されるため、コストが最小限に抑えられます。 ラボ リソースを削除する最も簡単な方法は、ラボ リソース グループを削除することです。 

+ Azure portal で、リソース グループを選び、**[リソース グループの削除]**、**[リソース グループ名を入力してください]** の順に選び、**[削除]** をクリックします。
+ Azure PowerShell を使用する場合は、「`Remove-AzResourceGroup -Name resourceGroupName`」と入力します。
+ CLI を使用する場合は、「`az group delete --name resourceGroupName`」と入力します。


## 要点

以上でラボは完了です。 このラボの要点は次のとおりです。 

+ Azure Backup サービスは、データをバックアップおよび回復するためのシンプルで安全、かつコスト効率の高いソリューションを提供します。
+ Azure Backup では、仮想マシンやファイル共有を含むオンプレミスおよびクラウド リソースを保護できます。
+ Azure Backup ポリシーでは、バックアップの頻度と回復ポイントの保持期間を構成します。 
+ Azure Site Recovery は、仮想マシンやアプリケーションの保護を提供するディザスター リカバリー ソリューションです。
+ Azure Site Recovery では、ワークロードがセカンダリ サイトにレプリケートされるため、障害または災害が発生した場合でも、セカンダリ サイトにフェールオーバーして最小限のダウンタイムで操作を再開できます。
+ Recovery Services コンテナーはバックアップ データを格納し、管理オーバーヘッドを最小限に抑えます。

## 自習トレーニングでさらに学習する

+ [Azure Backup を使用して仮想マシンを保護する](https://learn.microsoft.com/training/modules/protect-virtual-machines-with-azure-backup/)。 Azure Backup を使用して、オンプレミスのサーバー、仮想マシン、SQL Server、Azure ファイル共有、その他のワークロードを保護します。
+ 「[Azure Site Recovery を使用して Azure インフラストラクチャを保護する](https://learn.microsoft.com/en-us/training/modules/protect-infrastructure-with-site-recovery/)」。 Azure Site Recovery を使用して Azure 仮想マシンのレプリケーション、フェールオーバー、フェールバックをカスタマイズすることで、Azure インフラストラクチャのディザスター リカバリーを実現します。
