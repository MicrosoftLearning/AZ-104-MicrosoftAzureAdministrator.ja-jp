---
lab:
  title: 'ラボ 02a: サブスクリプションと RBAC を管理する'
  module: Administer Governance and Compliance
---

# ラボ 02a - サブスクリプションと RBAC を管理する
# 受講生用ラボ マニュアル

## ラボの要件

このラボでは、ユーザーを作成し、カスタムの Azure ロール ベースのアクセス制御 (RBAC) ロールを作成し、これらのロールをユーザーに割り当てるためのアクセス許可が必要です。 すべてのラボ ホスティング業者がこの機能を提供できるわけではありません。 このラボの可用性については、インストラクターに問い合わせてください。

## ラボのシナリオ

Contoso の Azure リソースの管理を強化するために、次の機能を実装する任務を負いました。

- Contoso のすべての Azure サブスクリプションを含む管理グループを作成する

- 管理グループ内のすべてのサブスクリプションに対するサポート要求を、指定されたユーザーに提出するアクセス許可を付与する。 そのユーザーのアクセス許可は、次の場合に限定する必要があります。 

    - サポート要求チケットの作成
    - リソース グループの表示

**メモ:** このラボをご自分のペースでクリックして進めることができる、 **[ラボの対話型シミュレーション](https://mslabs.cloudguides.com/guides/AZ-104%20Exam%20Guide%20-%20Microsoft%20Azure%20Administrator%20Exercise%202)** が用意されています。 対話型シミュレーションとホストされたラボの間に若干の違いがある場合がありますが、示されている主要な概念とアイデアは同じです。

## 目標

このラボでは、次のことを行います。

+ タスク 1:管理グループを実装する
+ タスク 2:カスタム RBAC ロールを作成する 
+ タスク 3:RBAC ロールを割り当てる


## 推定時間:30 分

## アーキテクチャの図

![image](../media/lab02aentra.png)


### Instructions

## 演習 1

## タスク 1:管理グループを実装する

このタスクでは、管理グループを作成および構成します。 

1. [**Azure Portal**](http://portal.azure.com) にサインインします。

1. 「**管理グループ**」を検索して選択し、**[管理グループ]** ブレードに移動します。

1. **[管理グループ]** ブレード上部のメッセージを確認します。 **"Directory 管理者として登録されていますが、ルート管理グループへのアクセスに必要な権限がありません"** というメッセージが表示された場合、以下の一連の手順を実行します。

    1. Azure portal で、**Microsoft Entra ID** を検索して選びます。
    
    1.  テナントのプロパティを表示しているブレードで、左側の垂直方向に配置されたメニュー内にある **[管理]** セクションから **[プロパティ]** を選択します。
    
    1.  テナントの **[プロパティ]** ブレードの **[Azure リソースのアクセス管理]** セクションで、 **[はい]** 、 **[保存]** の順に選択します。
    
    1.  **[管理グループ]** ブレードに戻り、**[更新​​]** をクリックします。

1. **[管理グループ]** ブレードで、**[+ 作成]** をクリックします。

    >**注**: 以前に管理グループを作成していない場合は、**[管理グループの使用を開始]** を選択します

1. 次の設定で管理グループを作成します。

    | 設定 | [値] |
    | --- | --- |
    | 管理グループ ID | **az104-02-mg1** |
    | 管理グループの表示名 | **az104-02-mg1** |

1. 管理グループのリストで、新しく作成された管理グループを表すエントリをクリックしします。

1. **[az104-02-mg1]** ブレードで、**[サブスクリプション]** をクリックします。 

1. **[az104-02-mg1 \| サブスクリプション]** ブレードで、 **[+ 追加]** をクリックし、 **[サブスクリプションの追加]** ブレードの **[サブスクリプション]** ドロップダウンリストから、このラボで使用するサブスクリプションを選択して、 **[保存]** をクリックします。

    >**注**: **[az104-02-mg1 \| サブスクリプション]** ブレードで、Azure サブスクリプションの ID をクリップボードにコピーします。 これは、次のタスクで必要になります。

## タスク 2:カスタム RBAC ロールを作成する

このタスクでは、カスタム RBAC ロールの定義を作成します。

1. ラボのコンピューターから **\\Allfiles\\Labs\\02\\az104-02a-customRoleDefinition.json** ファイルをメモ帳で開き、その内容を確認します。

   ```json
   {
      "Name": "Support Request Contributor (Custom)",
      "IsCustom": true,
      "Description": "Allows to create support requests",
      "Actions": [
          "Microsoft.Resources/subscriptions/resourceGroups/read",
          "Microsoft.Support/*"
      ],
      "NotActions": [
      ],
      "AssignableScopes": [
          "/providers/Microsoft.Management/managementGroups/az104-02-mg1",
          "/subscriptions/SUBSCRIPTION_ID"
      ]
   }
   ```
    > **注**:ファイルがラボ環境内のローカルのどこに格納されているかが分からない場合は、インストラクターに確認してください。

1. JSON ファイルの `SUBSCRIPTION_ID` プレースホルダーを、クリップボードにコピーしたサブスクリプション ID に置き換えて、変更を保存します。

1. Azure portal で、**[Cloud Shell]** ウィンドウを開くには、検索テキストボックスの右側にあるツールバー アイコンを直接クリックします。

1. **Bash** または **PowerShell** の選択を求めるメッセージが表示されたら、 **[PowerShell]** を選択します。 

    >**注**: **Cloud Shell** の初回起動時に **"ストレージがマウントされていません"** というメッセージが表示された場合は、このラボで使用しているサブスクリプションを選択し、**[ストレージの作成]** を選択します。 

1. [Cloud Shell] ペインのツールバーで、 **[ファイルのアップロード/ダウンロード]** アイコンをクリックし、ドロップダウン メニューの **[アップロード]** をクリックして、ファイル **\\Allfiles\\Labs\\02\\az104-02a-customRoleDefinition.json** を Cloud Shell のホーム ディレクトリにアップロードします。

1. Cloud Shell ウィンドウから、次の操作を実行して、カスタム ロール定義を作成します。

   ```powershell
   New-AzRoleDefinition -InputFile $HOME/az104-02a-customRoleDefinition.json
   ```

1. [Cloud Shell] ペインを閉じます。

## タスク 3:RBAC ロールを割り当てる

このタスクでは、ユーザーを作成し、前のタスクで作成した RBAC ロールをそのユーザーに割り当て、ユーザーが RBAC ロール定義で指定されたタスクを実行できることを確認します。

1. Azure portal で、**Microsoft Entra ID** を検索して選び、 **[ユーザー]** 、 **[+ 新しいユーザー]** の順にクリックします。

1. 次の設定で、新しいユーザーを作成します (他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | ユーザー名 | **az104-02-aaduser1**|
    | 名前 | **az104-02-aaduser1**|
    | 自分でパスワードを作成する | enabled |
    | 初期パスワード | **セキュリティで保護されたパスワードを指定する** |

    >**注**:**クリップボードに**完全な**ユーザー名**をコピーします。 このラボで後ほど必要になります。

1. Azure portal で、**az104-02-mg1** 管理グループに戻り、その**詳細**を表示します。

1. **[Access Control (IAM)]** に移動して、 **[追加]** をクリックし、 **[ロールの割り当ての追加]** を選択します。 **[ロール]** タブで、 **[サポート要求共同作成者 (カスタム)]** を検索します。 

    >**注**: カスタム役割が表示されない場合、作成後にカスタム役割が表示されるまでに最大 10 分かかることがあります。

1. **[ロール]** を選択して **[次へ]** をクリックします。 **[メンバー]** タブで、 **[メンバーの選択]** をクリックし、ユーザー アカウント az104-***********************.**********.onmicrosoft.com を**選択**します。 **[次へ]** をクリックし、 **[確認して割り当てる]** をクリックします。

1. **[InPrivate]** ブラウザー ウィンドウを開き、新しく作成したユーザー アカウントを使用して [Azure portal](https://portal.azure.com) にログインします。 パスワードの更新を求められたら、ユーザー用にパスワードを変更します。

    >**注**:ユーザー名を入力するのではなく、クリップボードの内容を貼り付けることができます。

1. Azure portal の **[InPrivate]** ブラウザー ウィンドウで、**[リソース グループ]** を検索して選択し、az104-02-aaduser1 ユーザーがすべてのリソース グループを表示できることを確認します。

1. Azure portal の **[InPrivate]** ブラウザー ウィンドウで、**[すべてのリソース]** を検索して選択し、az104-02-aaduser1 ユーザーにリソースを表示できないことを確認します。

1. Azure portal の **[InPrivate]** ブラウザー ウィンドウで、**[ヘルプとサポート]** を検索して選択し、**[サポート要求の作成]** をクリックします。 

1. **[InPrivate]** ブラウザー ウィンドウの **[ヘルプ + サポート - 新しいサポート リクエスト]** ブレードの **[問題の説明/概要]** タブの "概要" フィールドに、「**サービスとサブスクリプションの制限**」と入力し、 **[サービスとサブスクリプションの制限 (クォータ)]** という問題の種類を選択します。 このラボで使用しているサブスクリプションは、**[サブスクリプション]** ドロップダウン リストに表示されていることに注意してください。

    >**注**: このラボで使用しているサブスクリプションが **[サブスクリプション]** ドロップダウン リストに表示されている場合、使用しているアカウントに、サブスクリプション固有のサポート要求を作成するために必要なアクセス許可があることを示しています。

    >**注**: **[サービスとサブスクリプションの制限 (クォータ)]** オプションが表示されない場合は、Azure portal からサインアウトしてログインし直します。

1. サポート要求の作成を続行しないでください。 代わりに、Azure portal から az104-02-aaduser1 ユーザーとしてサインアウトし、[InPrivate] ブラウザー ウィンドウを閉じてください。

## タスク 4: リソースをクリーンアップする

   >**注**:新規に作成し、使用しなくなったすべての Azure リソースを削除することを忘れないでください。 この課題で作成したリソースで余分なコストは発生しませんが、未使用のリソースを削除すると予期しない料金は発生しなくなります。

   >**注**:ラボのリソースをすぐに削除できなくても心配する必要はありません。 リソースに依存関係が存在し、削除に時間がかかる場合があります。 リソースの使用状況を監視することは管理者の一般的なタスクであるため、ポータルでリソースを定期的にチェックして、クリーンアップの進捗を確認するようにしてください。

1. Azure portal で、**Microsoft Entra ID** を検索して選び、 **[ユーザー]** をクリックします。

1. **[ユーザー - すべてのユーザー]** ブレードで **[az104-02-aaduser1]** をクリックします。

1. **[az104-02-aaduser1 - プロファイル]** ブレードで、**[オブジェクト ID]** 属性の値をコピーします。

1. Azure portal 内の **[Cloud Shell]** で **PowerShell** セッションを開始します。

1. [Cloud Shell] ペインで、次の手順を実行してカスタム ロール定義の割り当てを削除します (`[object_ID]` プレースホルダーを、このタスクの前半でコピーした **az104-02-aaduser1** ユーザー アカウントの **object ID** 属性の値で置き換えます)。

   ```powershell
   
    $scope = (Get-AzRoleDefinition -Name 'Support Request Contributor (Custom)').AssignableScopes | Where-Object {$_ -like '*managementgroup*'}
    
    Remove-AzRoleAssignment -ObjectId '[object_ID]' -RoleDefinitionName 'Support Request Contributor (Custom)' -Scope $scope
   ```

1. [Cloud Shell] ウィンドウから次の手順を実行して、カスタム ロールの定義を削除します。

   ```powershell
   Remove-AzRoleDefinition -Name 'Support Request Contributor (Custom)' -Force
   ```

1. Azure portal で、**Microsoft Entra ID** の **[ユーザー - すべてのユーザー]** ブレードに戻り、**az104-02-aaduser1** ユーザー アカウントを削除します。

1. Azure portal で、**[管理グループ]** ブレードに戻ります。 

1. **[管理グループ]** ブレードで、**az104-02-mg1** 管理グループの下のサブスクリプションの横にある**省略記号**アイコンを選択し、**[移動]** を選択してサブスクリプションを **[テナント ルート管理グループ]** に移動します。

   >**注**:このラボを実行する前にカスタム管理グループ階層を作成した場合を除き、ターゲットの管理グループが**テナント ルート管理グループ**であると考えられます。
   
1. **[更新]** を選択して、サブスクリプションが **[テナント ルート管理グループ]** に正常に移動したことを確認します。

1. **[管理グループ]** ブレードに戻り、 **[az104-02-mg1]** 管理グループの右側にある**省略記号**アイコンをクリックし、 **[削除]** をクリックします。
  >**注**: **テナント ルート管理グループ**を削除できない場合は、**Azure サブスクリプション**が管理グループ下にある場合があります。 **テナント ルート管理グループ**から **Azure サブスクリプション**を移動し、グループを削除する必要があります。

## 確認

このラボでは、次のことを行いました。

- 管理グループを作成しました
- カスタム RBAC ロールを作成しました 
- RBAC ロールを割り当てました
