---
lab:
  title: 04 - 仮想ネットワークを実装する
  module: Module 04 - Virtual Networking
---

# <a name="lab-04---implement-virtual-networking"></a>ラボ 04 - 仮想ネットワークを実装する

# <a name="student-lab-manual"></a>受講生用ラボ マニュアル

## <a name="lab-scenario"></a>ラボのシナリオ

Azure バーチャル ネットワークの機能について学習します。 まず、Azure でいくつかの Azure 仮想マシンをホストするバーチャル ネットワークを作成するプランを立てます。 ネットワーク ベースのセグメンテーションを実装するため、バーチャル ネットワークの異なるサブネットにデプロイします。 また、プライベート IP アドレスとパブリック IP アドレスが時間の経過とともに変更されないようにする必要もあります。 Contoso のセキュリティ要件に準拠するには、インターネットからアクセスできる Azure 仮想マシンのパブリック エンドポイントを保護する必要があります。 最後に、バーチャル ネットワーク内とインターネットからの両方で、Azure 仮想マシンの DNS 名前解決を実装する必要があります。

## <a name="objectives"></a>目標

このラボでは、次のことを行います。

+ タスク 1:バーチャル ネットワークを作成および構成する
+ タスク 2:仮想マシンをバーチャル ネットワークにデプロイする
+ タスク 3:Azure VM のプライベート IP アドレスとパブリック IP アドレスを構成する
+ タスク 4:ネットワーク セキュリティ グループを構成する
+ タスク 5:内部の名前解決に Azure DNS を構成する
+ タスク 6:外部の名前解決に Azure DNS を構成する

## <a name="estimated-timing-40-minutes"></a>推定時間:40 分

## <a name="architecture-diagram"></a>アーキテクチャの図

![image](../media/lab04.png)

## <a name="instructions"></a>Instructions

### <a name="exercise-1"></a>演習 1

#### <a name="task-1-create-and-configure-a-virtual-network"></a>タスク 1:バーチャル ネットワークを作成および構成する

このタスクでは、Azure portal を使用して、複数のサブネットを持つバーチャル ネットワークを作成します。

1. [Azure portal](https://portal.azure.com) にサインインします。

1. Azure portal で、 **「バーチャル ネットワーク」** を検索して選択し、 **「バーチャル ネットワーク」** ブレードで **「+ 作成」** をクリックします。

1. バーチャル ネットワークを次の設定で作成します (その他の設定は既定値のままにします)。

    | 設定 | [値] |
    | --- | --- |
    | サブスクリプション | このラボで使用する Azure サブスクリプションの名前 |
    | リソース グループ | **新しい** リソース グループ **az104-04-rg1** の名前 |
    | 名前 | **az104-04-vnet1** |
    | リージョン | このラボで使用するサブスクリプションで使用できる Azure リージョンの名前 |

1. ページの下部の **[次へ: IP アドレス]** をクリックして、次の値を入力します

    | 設定 | 値 |
    | --- | --- |
    | IPv4 アドレス空間 | **10.40.0.0/20** |

1. **「+ サブネットの追加」** をクリックして、次の値を入力してから、 **「追加」** をクリックします

    | 設定 | 値 |
    | --- | --- |
    | サブネット名 | **subnet0** |
    | サブネットのアドレス範囲 | **10.40.0.0/24** |

1. 既定値をそのまま使用し、 **「確認および作成」** をクリックします。 検証を実行し、もう一度 **「作成」** をクリックしてデプロイを送信します。

    >**注:**  バーチャル ネットワークがプロビジョニングされるのを待ちます。 これに要する時間は 1 分未満です。

1. **「リソースに移動」** をクリックします

1. **「az104-04-vnet1** バーチャル ネットワーク」 ブレードで、 **「サブネット」** をクリックし、 **「+ サブネット」** をクリックします。

1. サブネットを次の設定で作成します (その他の設定は既定値のままにします)。

    | 設定 | [値] |
    | --- | --- |
    | 名前 | **subnet1** |
    | アドレス範囲 (CIDR ブロック) | **10.40.1.0/24** |
    | ネットワーク セキュリティ グループ | **なし** |
    | ルート テーブル | **なし** |

1. **[保存]**

#### <a name="task-2-deploy-virtual-machines-into-the-virtual-network"></a>タスク 2:仮想マシンをバーチャル ネットワークにデプロイする

このタスクでは、ARM テンプレートを使用して、Azure 仮想マシンをバーチャル ネットワークの異なるサブネットにデプロイします。

1. Azure portal の右上にあるアイコンをクリックして **Azure Cloud Shell** を開きます。

1. **Bash** または **PowerShell** の選択を求めるメッセージが表示されたら、 **[PowerShell]** を選択します。

    >**注**:**Cloud Shell** の初回起動時に **「ストレージがマウントされていません」** というメッセージが表示された場合は、このラボで使用しているサブスクリプションを選択し、 **「ストレージの作成」** を選択します。

1. [Cloud Shell] ペインのツールバーで、 **[ファイルのアップロード/ダウンロード]** アイコンをクリックし、ドロップダウン メニューで **[アップロード]** をクリックして、ファイル **\\Allfiles\\Labs\\04\\az104-04-vms-loop-template.json** と **\\Allfiles\\Labs\\04\\az104-04-vms-loop-parameters.json** を Cloud Shell のホーム ディレクトリにアップロードします。

    >**注**:各ファイルを別々にアップロードする必要がある場合があります。

1. パラメーター ファイルを編集し、パスワードを変更します。 シェルでのファイルの編集に関してヘルプが必要な場合は、インストラクターに相談してください。 ベスト プラクティスとして、パスワードなどのシークレットは、キー コンテナーに安全に保存する必要があります。 

1. [Cloud Shell] ペインで、次のコマンドを実行し、テンプレート ファイルとパラメーター ファイルを使用して、2 つの仮想マシンをデプロイします。

   ```powershell
   $rgName = 'az104-04-rg1'

   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-04-vms-loop-template.json `
      -TemplateParameterFile $HOME/az104-04-vms-loop-parameters.json
   ```

    >**注**:ARM テンプレートをデプロイするこの方法では、Azure PowerShell を使用します。 同等の Azure CLI コマンド **az deployment create** を実行して、同じタスクを実行することもできます (詳細については、「[Resource Manager テンプレートおよび Azure CLI を使用するリソースのデプロイ](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/deploy-cli)」を参照してください)。

    >**注**:次のタスクに進む前に、デプロイが完了するまで待機します。 これには 2 分ほどかかります。

    >**注**:リージョンでそのサイズの VM を使用できないことを示すエラーが発生した場合は、次の手順に従います。
    > 1. CloudShell で `{}` ボタンをクリックし、左側のバーから **az104-04-vms-loop-parameters.json** を選択して、`vmSize` パラメーターの値をメモしておきます。
    > 1. "az104-04-rg1" リソース グループがデプロイされている場所を確認します。 CloudShell で `az group show -n az104-04-rg1 --query location` を実行して、それを取得することができます。
    > 1. CloudShell で `az vm list-skus --location <Replace with your location> -o table --query "[? contains(name,'Standard_D2s')].name"` を実行します。
    > 1. `vmSize` パラメーターの値を、先ほど実行したコマンドによって返された値のいずれかに置き換えます。
    > 1. 次に、`New-AzResourceGroupDeployment` コマンドを再度実行して、テンプレートを再デプロイします。 上方向ボタンを数回押して、最後に実行されたコマンドを上に持ってくることができます。

1. [Cloud Shell] ペインを閉じます。

#### <a name="task-3-configure-private-and-public-ip-addresses-of-azure-vms"></a>タスク 3:Azure VM のプライベート IP アドレスとパブリック IP アドレスを構成する

このタスクでは、Azure 仮想マシンのネットワーク インターフェイスに割り当てられたパブリック IP アドレスとプライベート IP アドレスの静的割り当てを構成します。

   >**注**:プライベート IP アドレスとパブリック IP アドレスは、実際にネットワーク インターフェイスに割り当てられ、次に Azure 仮想マシンに接続されますが、Azure VM に割り当てられた IP アドレスを代わりに参照することもよくあります。

1. Azure portal で **「リソース グループ」** を検索して選択し、 **「リソース グループ」** ブレードで **「az104-04-rg1」** をクリックします。

1. **「az104-04-rg1** リソース グループ」 ブレードのリソースのリストで、「**az104-04-vnet1」** をクリックします。

1. **「az104-04-vnet1** バーチャル ネットワーク」 ブレードで、 **「接続デバイス」** セクションを確認し、バーチャル ネットワークに接続されている 2 つのネットワーク インターフェイス **az104-04-nic0** と **az104-04-nic1** があることを確認します。

1. **「az104-04-nic0」** をクリックし、 **「az104-04-nic0」** ブレードで **「IP 構成」** をクリックします。

    >**注**:**ipconfig1** が動的プライベート IP アドレスで現在設定されていることを確認します。

1. IP 構成のリストで、 **「ipconfig1」** をクリックします。

1. **ipconfig1** ブレードの **「パブリック IP アドレス設定」** セクションで、 **「関連付け」** を選択し、 **「+ 新規作成」** をクリックして、次の設定を指定し、 **「OK」** をクリックします。

    | 設定 | [値] |
    | --- | --- |
    | 名前 | **az104-04-pip0** |
    | SKU | **Standard** |

1. **「ipconfig1」** ブレードで **「割り当て」** を **「静的」** に設定し、 **「IP アドレス」** の既定値を **10.40.0.4** のままにします。

1. **「ipconfig1」** ブレードに戻り、変更を保存します。 次の手順に進む前に、必ず保存操作が完了するのを待ってください。

1. **「az104-04-vnet1」** ブレードに戻ります。

1. **[az104-04-nic1]** をクリックし、 **[az104-04-nic1]** ブレードで **[IP 構成]** をクリックします。

    >**注**:**ipconfig1** が動的プライベート IP アドレスで現在設定されていることを確認します。

1. IP 構成のリストで、 **「ipconfig1」** をクリックします。

1. **ipconfig1** ブレードの **「パブリック IP アドレス設定」** セクションで、 **「関連付け」** を選択し、 **「+ 新規作成」** をクリックして、次の設定を指定し、 **「OK」** をクリックします。

    | 設定 | [値] |
    | --- | --- |
    | 名前 | **az104-04-pip1** |
    | SKU | **Standard** |

1. **[ipconfig1]** ブレードで **[割り当て]** を **[静的]** に設定し、 **[IP アドレス]** の既定値を **[10.40.1.4]** のままにします。

1. **「ipconfig1」** ブレードに戻り、変更を保存します。

1. **「az104-04-rg1** リソース グループ」 ブレードに戻り、そのリソースのリストで **「az104-04-vm0」** をクリックし、 **「az104-04-vm0** 仮想マシン」 ブレードでパブリック IP アドレスのエントリをメモします。

1. **[az104-04-rg1]** の [リソース グループ] ブレードに戻り、そのリソースのリストで **[az104-04-vm1]** をクリックし、 **[az104-04-vm1]** の [仮想マシン] ブレードでパブリック IP アドレスのエントリをメモします。

    >**注**:このラボの最後のタスクで、両方の IP アドレスが必要になります。

#### <a name="task-4-configure-network-security-groups"></a>タスク 4:ネットワーク セキュリティ グループを構成する

このタスクでは、Azure 仮想マシンへの接続を制限できるように、ネットワーク セキュリティ グループを構成します。

1. Azure portal で **「az104-04-rg1** リソース グループ」 ブレードに戻り、そのリソースのリストで **「az104-04-vm0」** をクリックします。

1. **「az104-04-vm0** 概要」 ブレードで、 **「接続」** をクリックし、ドロップダウン メニューで **「RDP」** をクリックし、 **「RDP を使用して接続する」** ブレードで **「パブリック IP アドレスを使用して RDP ファイルのダウンロード」** をクリックし、プロンプトに従ってリモート デスクトップ セッションを開始します。

1. 接続の試行が失敗することに注意してください。

    >**注**:これは想定されたことです。既定では、Standard SKU のパブリック IP アドレスが割り当てられたネットワーク インターフェイスは、ネットワーク セキュリティ グループで保護されている必要があるためです。 リモート デスクトップ接続を許可するには、インターネットからの受信 RDP トラフィックを明示的に許可するネットワーク セキュリティ グループを作成し、両方の仮想マシンのネットワーク インターフェイスに割り当てます。

1. 仮想マシン **az104-04-vm0** と **az104-04-vm1** を停止します。

    >**注**:これはラボの便宜のために行われます。 ネットワーク セキュリティ グループがネットワーク インターフェイスに接続されているときに仮想マシンが実行中の場合は、その接続が有効になるまでに 30 分以上かかることがあります。 ネットワーク セキュリティ グループが作成されて接続されると、仮想マシンは再起動され、接続が直ちに有効になります。

1. Azure portal で **「ネットワーク セキュリティ グループ」** を検索して選択し、 **「ネットワーク セキュリティ グループ」** ブレードで **「+ 作成」** をクリックします。

1. ネットワーク セキュリティ グループを次の設定で作成します (その他の設定は既定値のままにします)。

    | 設定 | [値] |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-04-rg1** |
    | 名前 | **az104-04-nsg01** |
    | リージョン | このラボで他のすべてのリソースをデプロイする Azure リージョンの名前 |

1. **[確認と作成]** をクリックします。 検証を実行し、 **「作成」** をクリックしてデプロイを送信します。

    >**注**: デプロイが完了するまで待ちます。 これには 2 分ほどかかります。

1. 「デプロイ」 ブレードで **「リソースに移動」** をクリックして、 **「az104-04-nsg01** ネットワーク セキュリティ グループ」 ブレードを開きます。

1. **「az104-04-nsg01** ネットワーク セキュリティ グループ」 ブレードの **「設定」** セクションで、 **「受信セキュリティ ルール」** をクリックします。

1. 次の設定を使用して受信ルールを追加します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | source | **[任意]** |
    | Source port ranges | * |
    | 到着地 | **[任意]** |
    | サービス | **RDP** |
    | アクション | **許可** |
    | Priority | **300** |
    | 名前 | **AllowRDPInBound** |

1. **「az104-04-nsg01** ネットワーク セキュリティ グループ」 ブレードの **「設定」** セクションで、 **「ネットワーク インターフェイス」** をクリックし、 **「+ 関連付け」** をクリックします。

1. **「az104-04-nsg01** ネットワーク セキュリティ グループ」 を **「az104-04-nic0** ネットワーク インターフェイス」 および 「**az104-04-nic1** ネットワーク インターフェイス」 に関連付けます。

    >**注**:新しく作成されたネットワーク セキュリティ グループのルールがネットワーク インターフェイス カードに適用されるまで、最大 5 分かかる場合があります。

1. 仮想マシン **az104-04-vm0** と **az104-04-vm1** を開始します。

1. **「az104-04-vm0** 仮想マシン」 ブレードに戻ります。

    >**注**:後続のステップで、ターゲット仮想マシンに正常に接続できることを確認します。

1. **「az104-04-vm0」** ブレードで、 **「接続」** をクリックし、 **「RDP」** をクリック。 **「RDP を使用して接続する」** ブレードで **「パブリック IP アドレスを使用して RDP ファイルのダウンロード」** をクリックし、プロンプトに従ってリモート デスクトップ セッションを開始します。

    >**注**:この手順では、Windows コンピューターからリモート デスクトップ経由で接続することを指します。 Mac では、Mac App Store からリモート デスクトップ クライアントを使用でき、Linux コンピューターでは、オープンソースの RDP クライアント ソフトウェアを使用できます。

    >**注**:ターゲット仮想マシンに接続する際は、警告メッセージを無視できます。

1. プロンプトが表示されたら、パラメーター ファイルのユーザーとパスワードを使用してサインインします。

    >**注**:リモート デスクトップ セッションを開いたままにします。 これは、次のタスクで必要になります。

#### <a name="task-5-configure-azure-dns-for-internal-name-resolution"></a>タスク 5:内部の名前解決に Azure DNS を構成する

このタスクでは、Azure プライベート DNS ゾーンを使用して、バーチャル ネットワーク内で DNS 名前解決を構成します。

1. Azure portal で、 **「プライベート DNS ゾーン」** を検索して選択し、 **「プライベート DNS ゾーン」** ブレードで **「+ 作成」** をクリックします。

1. プライベート DNS ゾーンを次の設定で作成します (その他の設定は既定値のままにします)。

    | 設定 | [値] |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-04-rg1** |
    | 名前 | **contoso.org** |

1. **[確認と作成]** をクリックします。 検証を実行し、もう一度 **「作成」** をクリックしてデプロイを送信します。

    >**注**: プライベート DNS ゾーンが作成されるまで待ちます。 これには 2 分ほどかかります。

1. **「リソースに移動」** をクリックして **「contoso.org** DNS プライベート ゾーン」 ブレードを開きます。

1. **「contoso.org** プライベート DNS ゾーン」 ブレードの **「設定」** セクションで、 **「バーチャル ネットワーク リンク」** をクリックします。

1. **「+ 追加」** をクリックしえ、バーチャル ネットワーク リンクを次の設定で作成します (他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | リンク名 | **az104-04-vnet1-link** |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | 仮想ネットワーク | **az104-04-vnet1** |
    | 自動登録を有効にする | enabled |

1. **[OK]** をクリックします。

    >**注:** 仮想ネットワーク リンクが作成されるまで待ちます。 これにかかる時間は 1 分未満です。

1. **「contoso.org** プライベート DNS ゾーン」 ブレードのサイドバーで、 **「概要」** をクリックします。

1. **az104-04-vm0** および **az104-04-vm1** の DNS レコードが、レコード セットのリストに **自動登録** として表示されることを確認 します。

    >**注:** レコード セットが一覧に表示されない場合は、必要に応じて数分待ってからページを更新してください。

1. リモート デスクトップ セッションを **az104-04-vm0** に切り替えて、 **「スタート」** ボタンを右クリックし、右クリック メニューで、 **「Windows PowerShell (管理者)」** をクリックします。

1. Windows PowerShell コンソール ウィンドウで次のコマンドを実行して、新しく作成したプライベート DNS ゾーン内の内部名前解決をテストします。

   ```powershell
   nslookup az104-04-vm0.contoso.org
   nslookup az104-04-vm1.contoso.org
   ```

1. コマンドの出力に、**az104-04-vm1** (**10.40.1.4**) のプライベート IP アドレスが含まれていることを確認します。

#### <a name="task-6-configure-azure-dns-for-external-name-resolution"></a>タスク 6:外部の名前解決に Azure DNS を構成する

このタスクでは、Azure パブリック DNS ゾーンを使って外部 DNS 名前解決を構成します。

1. **SEA-DEV** ラボ システムの Web ブラウザーで、新しいタブを開き、<https://www.godaddy.com/domains/domain-name-search> に移動します。

1. ドメイン名検索を使用して、使用されていないドメイン名を識別します。

1. Azure portal で「**DNS ゾーン**」と検索してそれを選択し、 **[DNS ゾーン]** ブレードで **[+ 追加]** をクリックします。

1. 次の設定で DNS ゾーンを作成します (その他は既定値のままにします)。

    | 設定 | [値] |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-04-rg1** |
    | 名前 | このタスクの先ほど確認した DNS ドメイン名 |

1. **[確認と作成]** をクリックします。 検証を実行し、もう一度 **「作成」** をクリックしてデプロイを送信します。

    >**注**: DNS ゾーンが作成されるまで待ちます。 これには 2 分ほどかかります。

1. 「**リソースに移動**」 をクリックして、新しく作成した DNS ゾーンのブレードを開きます。

1. 「DNS ゾーン」 ブレードで、「 **+ レコード セット**」 をクリックします。

1. 次の設定でレコード セットを追加します (その他は既定値のままにします)。

    | 設定 | [値] |
    | --- | --- |
    | 名前 | **az104-04-vm0** |
    | Type | **A** |
    | エイリアスのレコード セット | **No** |
    | TTL | **1** |
    | TTL の単位 | **Hours** |
    | IP アドレス | このラボの 3 番目の演習で特定した **az104-04-vm0** のパブリック IP アドレス |

1. **[OK]**

1. 「DNS ゾーン」 ブレードで、「 **+ レコード セット**」 をクリックします。

1. 次の設定でレコード セットを追加します (その他は既定値のままにします)。

    | 設定 | [値] |
    | --- | --- |
    | 名前 | **az104-04-vm1** |
    | Type | **A** |
    | エイリアスのレコード セット | **No** |
    | TTL | **1** |
    | TTL の単位 | **Hours** |
    | IP アドレス | このラボの 3 番目の演習で特定した **az104-04-vm1** のパブリック IP アドレス |

1. **[OK]**

1. 「DNS ゾーン」 ブレードで、「**ネーム サーバー 1**」 のエントリの名前をメモします。

1. Azure portal で、右上にあるアイコンをクリックして、 **「Cloud Shell」** の **「PowerShell」** セッションを開きます。

1. [Cloud Shell] ペインで次のコマンドを実行して、新しく作成された DNS ゾーンに設定されている **az104-04-vm0** DNS レコード セットの外部名前解決をテストします (プレースホルダー `[Name server 1]` をこのタスクで前にメモした **[ネーム サーバー 1]** の名前に、プレースホルダー `[domain name]` をこのタスクで前に作成した DNS ドメインの名前に置き換えます)。

   ```powershell
   nslookup az104-04-vm0.[domain name] [Name server 1]
   ```

1. コマンドの出力に、**az104-04-vm0** のパブリック IP アドレスが含まれていることを確認します。

1. [Cloud Shell] ペインで次のコマンドを実行して、新しく作成された DNS ゾーンに設定されている **az104-04-vm1** DNS レコード セットの外部名前解決をテストします (プレースホルダー `[Name server 1]` をこのタスクで前にメモした **[ネーム サーバー 1]** の名前に、プレースホルダー `[domain name]` をこのタスクで前に作成した DNS ドメインの名前に置き換えます)。

   ```powershell
   nslookup az104-04-vm1.[domain name] [Name server 1]
   ```

1. コマンドの出力に、**az104-04-vm1** のパブリック IP アドレスが含まれていることを確認します。

#### <a name="clean-up-resources"></a>リソースをクリーンアップする

 > **注**:新規に作成し、使用しなくなったすべての Azure リソースを削除することを忘れないでください。 使用していないリソースを削除することで、予期しない料金が発生しなくなります。

 > **注**:ラボのリソースをすぐに削除できなくても心配する必要はありません。 リソースに依存関係が存在し、削除に時間がかかる場合があります。 リソースの使用状況を監視することは管理者の一般的なタスクであるため、ポータルでリソースを定期的にチェックして、クリーンアップの進捗を確認するようにしてください。 

1. Azure portal で、**[Cloud Shell]** ペイン内に **PowerShell** セッションを開きます。

1. 次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを表示します。

   ```powershell
   Get-AzResourceGroup -Name 'az104-04*'
   ```

1. 次のコマンドを実行して、このモジュールのラボ全体を通して作成したすべてのリソース グループを削除します。

   ```powershell
   Get-AzResourceGroup -Name 'az104-04*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注**:このコマンドは非同期で実行されるため (-AsJob パラメーターによって決定されます)、同じ PowerShell セッション内で直後に別の PowerShell コマンドを実行できますが、リソース グループが実際に削除されるまでに数分かかります。

#### <a name="review"></a>確認

このラボでは、次のことを行いました。

+ バーチャル ネットワークを作成して構成しました
+ 仮想マシンをバーチャル ネットワークにデプロイしました
+ Azure VM のプライベート IP アドレスとパブリック IP アドレスを構成しました
+ ネットワーク セキュリティ グループを構成しました
+ Azure DNS を内部の名前解決用に構成しました
+ Azure DNS を外部の名前解決用に構成しました
